<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sonuçları</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<main class="results-container">
    <div class="results-card" id="results-card">
        <h1>Siyasi Pusulanızın Sonuçları</h1>
        <p>Görüşleriniz, aşağıdaki siyasi eksenlerde bu şekilde konumlanıyor.</p>

        <div class="results-grid">
            <div class="compass-column">
                <div class="political-compass">
                    <span class="compass-axis-label top-label">Muhafazakâr</span>
                    <span class="compass-axis-label bottom-label">İlerici</span>
                    <span class="compass-axis-label left-label">Sol</span>
                    <span class="compass-axis-label right-label">Sağ</span>

                    <div class="quadrant" style="background-color: #c0392b;"></div>
                    <div class="quadrant" style="background-color: #3498db;"></div>
                    <div class="quadrant" style="background-color: #27ae60;"></div>
                    <div class="quadrant" style="background-color: #8e44ad;"></div>

                    <div id="user-position-dot" class="user-dot"></div>
                </div>
            </div>

            <div class="results-column">
                <div class="results-list">
                    <div class="axis-result">
                        <span class="axis-title">Sol / Sağ</span>
                        <p id="solsag-result" class="result-label">...</p>
                        <div class="score-bar">
                            <div id="solsag-score-line" class="score-line"></div>
                        </div>
                    </div>

                    <div class="axis-result">
                        <span class="axis-title">Liberal / Otokrat</span>
                        <p id="libotok-result" class="result-label">...</p>
                        <div class="score-bar">
                            <div id="libotok-score-line" class="score-line"></div>
                        </div>
                    </div>

                    <div class="axis-result">
                        <span class="axis-title">İlerici / Muhafazakâr</span>
                        <p id="ilericimuhafazakar-result" class="result-label">...</p>
                        <div class="score-bar">
                            <div id="ilericimuhafazakar-score-line" class="score-line"></div>
                        </div>
                    </div>

                    <div class="axis-result">
                        <span class="axis-title">Küreselci / Milliyetçi</span>
                        <p id="kurmil-result" class="result-label">...</p>
                        <div class="score-bar">
                            <div id="kurmil-score-line" class="score-line"></div>
                        </div>
                    </div>

                    <div class="axis-result">
                        <span class="axis-title">Federal / Üniter</span>
                        <p id="feduni-result" class="result-label">...</p>
                        <div class="score-bar">
                            <div id="feduni-score-line" class="score-line"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="party-results-container">
            <h2>En Yakın Olduğunuz Partiler</h2>
            <ol id="party-list" class="party-list"></ol>
        </div>

        <div class="results-actions">
            <a href="test.html" class="main-button retake-button">Testi Yeniden Çöz</a>
            <button id="download-btn" class="main-button download-button">PNG Olarak İndir</button>
        </div>
    </div>
</main>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
    // URL'den gelen parametreleri (puanları) al
    function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
            solsag: parseInt(params.get('solsag')),
            libotok: parseInt(params.get('libotok')),
            ilericimuhafazakar: parseInt(params.get('ilericimuhafazakar')),
            kurmil: parseInt(params.get('kurmil')),
            feduni: parseInt(params.get('feduni'))
        };
    }

    // Her eksen için puana karşılık gelen etiketi belirle
    function getLabel(score, axis) {
        if (axis === 'solsag') {
            if (score >= 9) return "Klasik Liberalizm";
            if (score >= 3 && score <= 8) return "Liberalizm";
            if (score >= -2 && score <= 2) return "Karma Ekonomi";
            if (score >= -8 && score <= -3) return "Sosyal Demokrasi";
            if (score <= -9) return "Sosyalizm";
        }
        if (axis === 'libotok') {
            if (score >= 9) return "Anarşizm";
            if (score >= 3 && score <= 8) return "Özgürlükçülük";
            if (score >= -2 && score <= 2) return "Hibrit Rejim";
            if (score >= -8 && score <= -3) return "Otoriterlik";
            if (score <= -9) return "Totalitarizm";
        }
        if (axis === 'ilericimuhafazakar') {
            if (score >= 5) return "Teokrasi";
            if (score >= -4 && score <= 4) return "Laiklik";
            if (score <= -5) return "Din Karşıtlığı (Antiteist)";
        }
        if (axis === 'kurmil') {
            if (score >= 5) return "Küreselcilik";
            if (score >= -4 && score <= 4) return "Enternasyonalizm";
            if (score <= -5) return "Milliyetçilik";
        }
        if (axis === 'feduni') {
            if (score >= 5) return "Konfederasyonculuk";
            if (score >= -4 && score <= 4) return "Federal Cumhuriyetçilik";
            if (score <= -5) return "Ünitercilik";
        }
        return "Belirlenemedi";
    }

    // Puan çubuklarını yeni renk şemalarına göre güncelle
    function updateScoreBars(scores) {
        const maxScore = 12; // Yeni puan ölçeği
        const axes = ['solsag', 'libotok', 'ilericimuhafazakar', 'kurmil', 'feduni'];

        const colorSchemes = {
            solsag: { start: 'rgb(255, 0, 0)', end: 'rgb(0, 0, 255)' },
            libotok: { start: 'rgb(0, 0, 255)', end: 'rgb(255, 0, 0)' },
            ilericimuhafazakar: { start: 'rgb(128, 0, 128)', end: 'rgb(0, 128, 0)' },
            kurmil: { start: 'rgb(255, 0, 0)', end: 'rgb(0, 0, 255)' },
            feduni: { start: 'rgb(0, 128, 0)', end: 'rgb(255, 255, 0)' }
        };

        function interpolateColor(color1, color2, factor) {
            const c1 = color1.match(/\d+/g).map(Number);
            const c2 = color2.match(/\d+/g).map(Number);
            const result = c1.map((c, i) => Math.round(c + (c2[i] - c) * factor));
            return `rgb(${result[0]}, ${result[1]}, ${result[2]})`;
        }

        axes.forEach(axis => {
            const score = scores[axis];
            if (score === null || isNaN(score)) return;

            const scoreLine = document.getElementById(`${axis}-score-line`);
            const scoreFactor = (score + maxScore) / (2 * maxScore);

            const startColor = colorSchemes[axis].start;
            const endColor = colorSchemes[axis].end;
            const interpolatedColor = interpolateColor(startColor, endColor, scoreFactor);

            scoreLine.style.width = `${scoreFactor * 100}%`;
            scoreLine.style.backgroundColor = interpolatedColor;
        });
    }

    // 2D Pusula çizimi ve kullanıcı noktasını yerleştirme
    function drawPoliticalCompass(scores) {
        const compass = document.querySelector('.political-compass');
        const userDot = document.getElementById('user-position-dot');
        const maxScore = 12; // Yeni puan ölçeği
        const totalSize = 300; // Pusula karelerinin toplam genişliği

        // Pusula Y ekseni için Liberal/Otokrat puanını kullan
        // Y ekseni görseldeki gibi tersine çevrilmiş
        const xPos = (scores.solsag + maxScore) / (2 * maxScore) * totalSize;
        const yPos = (scores.ilericimuhafazakar - maxScore) / (-2 * maxScore) * totalSize;

        userDot.style.left = `${xPos}px`;
        userDot.style.top = `${yPos}px`;
    }

    // VERECEĞİN PARTİ PUANLARI VE RENKLERİ BURADA GİRİLECEK
    const partyScores = [
        { name: 'AK Parti - Adalet ve Kalkınma Partisi', solsag: 0, libotok: -9, ilericimuhafazakar: 9, kurmil: -9, feduni: 3, color: '#f8991d' },
        { name: 'MHP - Milliyetçi Hareket Partisi', solsag: 0, libotok: -9, ilericimuhafazakar: 9, kurmil: -12, feduni: 3, color: '#8e1c4b' },
        { name: 'Büyük Birlik - Büyük Birlik Partisi', solsag: 0, libotok: -9, ilericimuhafazakar: 9, kurmil: -12, feduni: -3, color: '#ea2228' },
        { name: 'HÜDA PAR - Hür Dava Partisi', solsag: 6, libotok: -9, ilericimuhafazakar: 12, kurmil: -6, feduni: 12, color: '#00953b' },
        { name: 'CHP - Cumhuriyet Halk Partisi', solsag: -3, libotok: 9, ilericimuhafazakar: -9, kurmil: 3, feduni: -9, color: '#e30613' },
        { name: 'İYİ Parti', solsag: 6, libotok: 6, ilericimuhafazakar: -6, kurmil: 0, feduni: -9, color: '#3cb4e5' },
        { name: 'Zafer Partisi', solsag: 0, libotok: 3, ilericimuhafazakar: -3, kurmil: -6, feduni: -12, color: '#414042' },
        { name: 'DEM Parti - Halkların Eşitlik ve Demokrasi Partisi', solsag: -6, libotok: 9, ilericimuhafazakar: -9, kurmil: 9, feduni: 12, color: '#773e90' },
        { name: 'TİP - Türkiye İşçi Partisi', solsag: -9, libotok: 9, ilericimuhafazakar: -12, kurmil: 6, feduni: 9, color: '#ad1766' },
        { name: 'Yeniden Refah - Yeniden Refah Partisi', solsag: 0, libotok: -6, ilericimuhafazakar: 12, kurmil: -12, feduni: -3, color: '#467d18' },
        { name: 'A Parti - Anahtar Parti', solsag: 3, libotok: -3, ilericimuhafazakar: 9, kurmil: -7, feduni: -9, color: '#002157' },
        { name: 'DEVA Partisi - Demokrasi ve Atılım Partisi', solsag: 9, libotok: 9, ilericimuhafazakar: 0, kurmil: 9, feduni: 0, color: '#0069a7' },
        { name: 'Gelecek Partisi', solsag: 9, libotok: 6, ilericimuhafazakar: 3, kurmil: 6, feduni: -6, color: '#0d6e4a' },
        { name: 'Saadet - Saadet Partisi', solsag: 0, libotok: -3, ilericimuhafazakar: 9, kurmil: -12, feduni: -3, color: '#c16d4f' },
        { name: 'BTP - Bağımsız Türkiye Partisi', solsag: 0, libotok: 0, ilericimuhafazakar: 6, kurmil: -9, feduni: -12, color: '#c80008' }
    ];

    // Partilere olan mesafeleri hesapla ve en yakın 3'ünü bul
    function calculatePartyDistances(userScores) {
        const distances = partyScores.map(party => {
            const distance = Math.sqrt(
                Math.pow(userScores.solsag - party.solsag, 2) +
                Math.pow(userScores.libotok - party.libotok, 2) +
                Math.pow(userScores.ilericimuhafazakar - party.ilericimuhafazakar, 2) +
                Math.pow(userScores.kurmil - party.kurmil, 2) +
                Math.pow(userScores.feduni - party.feduni, 2)
            );
            return { name: party.name, distance: distance, color: party.color };
        });

        // En büyük mesafeyi bul
        const maxDistance = Math.max(...distances.map(d => d.distance));

        // Mesafeleri yüzdelik skora dönüştür
        const scoresWithPercentage = distances.map(d => {
            const percentage = (1 - (d.distance / maxDistance)) * 100;
            return {
                name: d.name,
                percentage: percentage.toFixed(1),
                color: d.color
            };
        });

        // Yüzdelik skora göre sırala (azalan) ve en yakın 3'ünü al
        scoresWithPercentage.sort((a, b) => b.percentage - a.percentage);
        return scoresWithPercentage.slice(0, 3);
    }

    // En yakın partileri ekranda göster
    function displayPartyResults(topParties) {
        const partyList = document.getElementById('party-list');
        partyList.innerHTML = ''; // Listeyi temizle
        topParties.forEach(party => {
            const listItem = document.createElement('li');
            listItem.innerHTML = `<span class="party-result-label" style="color: ${party.color};">${party.name}</span> <span class="distance-label">Yakınlık Skoru: %${party.percentage}</span>`;
            partyList.appendChild(listItem);
        });
    }

    // Sonuçları PNG olarak indirme fonksiyonu
    function downloadResultsAsPng() {
        const elementToCapture = document.getElementById('results-card');

        html2canvas(elementToCapture, {
            scale: 2,
            backgroundColor: null,
            allowTaint: true,
            useCORS: true
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'siyasi-pusula-sonuc.png';
            link.href = canvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    }

    // Sayfa yüklendiğinde çalışacak ana fonksiyon
    function initializeResultsPage() {
        const scores = getUrlParams();
        document.getElementById('solsag-result').innerText = getLabel(scores.solsag, 'solsag');
        document.getElementById('libotok-result').innerText = getLabel(scores.libotok, 'libotok');
        document.getElementById('ilericimuhafazakar-result').innerText = getLabel(scores.ilericimuhafazakar, 'ilericimuhafazakar');
        document.getElementById('kurmil-result').innerText = getLabel(scores.kurmil, 'kurmil');
        document.getElementById('feduni-result').innerText = getLabel(scores.feduni, 'feduni');

        updateScoreBars(scores);
        drawPoliticalCompass(scores);

        const topParties = calculatePartyDistances(scores);
        displayPartyResults(topParties);

        // İndirme butonuna event listener ekle
        document.getElementById('download-btn').addEventListener('click', downloadResultsAsPng);
    }

    document.addEventListener('DOMContentLoaded', initializeResultsPage);
</script>
</body>
</html>