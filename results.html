<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sonuçları</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<main class="results-container">
    <div class="results-card" id="results-card">
        <h1>Siyasi Pusulanızın Sonuçları</h1>
        <p>Görüşleriniz, aşağıdaki siyasi eksenlerde bu şekilde konumlanıyor.</p>

        <div class="results-grid">
            <div class="compass-column">
                <div class="political-compass">
                    <span class="compass-axis-label top-label">Muhafazakâr</span>
                    <span class="compass-axis-label bottom-label">İlerici</span>
                    <span class="compass-axis-label left-label">Sol</span>
                    <span class="compass-axis-label right-label">Sağ</span>

                    <div class="quadrant" style="background-color: #c0392b;"></div>
                    <div class="quadrant" style="background-color: #3498db;"></div>
                    <div class="quadrant" style="background-color: #27ae60;"></div>
                    <div class="quadrant" style="background-color: #8e44ad;"></div>

                    <div id="user-position-dot" class="user-dot"></div>
                </div>
            </div>

            <div class="results-column">
                <div class="results-list">
                    <div class="axis-result">
                        <span class="axis-title">Sol / Sağ</span>
                        <p id="solsag-result" class="result-label">...</p>
                        <div class="score-bar">
                            <div id="solsag-score-line" class="score-line"></div>
                        </div>
                    </div>

                    <div class="axis-result">
                        <span class="axis-title">Özgürlük / Otokrasi</span>
                        <p id="libotok-result" class="result-label">...</p>
                        <div class="score-bar">
                            <div id="libotok-score-line" class="score-line"></div>
                        </div>
                    </div>

                    <div class="axis-result">
                        <span class="axis-title">İlericilik / Muhafazakârlık</span>
                        <p id="ilericimuhafazakar-result" class="result-label">...</p>
                        <div class="score-bar">
                            <div id="ilericimuhafazakar-score-line" class="score-line"></div>
                        </div>
                    </div>

                    <div class="axis-result">
                        <span class="axis-title">Küreselcilik / Milliyetçilik</span>
                        <p id="kurmil-result" class="result-label">...</p>
                        <div class="score-bar">
                            <div id="kurmil-score-line" class="score-line"></div>
                        </div>
                    </div>

                    <div class="axis-result">
                        <span class="axis-title">Ünitercilik / Federalizm</span>
                        <p id="unifed-result" class="result-label">...</p>
                        <div class="score-bar">
                            <div id="unifed-score-line" class="score-line"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="party-results-container">
            <h2>En Yakın Olduğunuz Partiler</h2>
            <ol id="party-list" class="party-list"></ol>
        </div>

        <div class="results-actions">
            <a href="test.html" class="main-button retake-button">Testi Yeniden Çöz</a>
            <button id="download-btn" class="main-button download-button">PNG Olarak İndir</button>
        </div>
    </div>
</main>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
    const maxScore = 20;

    // Puan aralıklarını ve karşılık gelen etiketleri basit bir nesnede tut
    const labels = {
        solsag: [
            { min: 18, max: maxScore, label: "Klasik Liberalizm" },
            { min: 5, max: 18, label: "Liberalizm" },
            { min: -5, max: 5, label: "Karma Ekonomi" },
            { min: -18, max: -5, label: "Sosyal Demokrasi" },
            { min: -maxScore, max: -18, label: "Sosyalizm" }
        ],
        libotok: [
            { min: 18, max: maxScore, label: "Anarşizm" },
            { min: 5, max: 18, label: "Özgürlükçülük" },
            { min: -5, max: 5, label: "Hibrit Rejim" },
            { min: -18, max: -5, label: "Otoriterlik" },
            { min: -maxScore, max: -18, label: "Totalitarizm" }
        ],
        ilericimuhafazakar: [
            { min: 12, max: maxScore, label: "Teokrasi" },
            { min: -12, max: 12, label: "Laiklik" },
            { min: -maxScore, max: -12, label: "Din Karşıtlığı" }
        ],
        kurmil: [
            { min: 12, max: maxScore, label: "Küreselcilik" },
            { min: -12, max: 12, label: "Enternasyonalizm" },
            { min: -maxScore, max: -12, label: "Milliyetçilik" }
        ],
        unifed: [
            { min: 12, max: maxScore, label: "Konfederasyonculuk" },
            { min: -12, max: 12, label: "Adem-i Merkeziyetçilik" },
            { min: -maxScore, max: -12, label: "Ünitercilik" }
        ]
    };

    function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
            solsag: parseFloat(params.get('solsag')),
            libotok: parseFloat(params.get('libotok')),
            ilericimuhafazakar: parseFloat(params.get('ilericimuhafazakar')),
            kurmil: parseFloat(params.get('kurmil')),
            unifed: parseFloat(params.get('unifed'))
        };
    }

    // Basitleştirilmiş yeni getLabel fonksiyonu
    function getLabel(score, axis) {
        if (score === null || isNaN(score)) return "Belirlenemedi";

        // Puan aralıklarını ters sırada kontrol et, en büyük aralıktan başlayarak
        const sortedLabels = [...labels[axis]].sort((a, b) => b.min - a.min);

        for (const range of sortedLabels) {
            if (score >= range.min && score <= range.max) {
                return range.label;
            }
        }
        return "Belirlenemedi";
    }

    function updateScoreBars(scores) {
        const axes = ['solsag', 'libotok', 'ilericimuhafazakar', 'kurmil', 'unifed'];
        const colorSchemes = {
            solsag: { start: 'rgb(255, 0, 0)', end: 'rgb(0, 0, 255)' },
            libotok: { start: 'rgb(0, 0, 255)', end: 'rgb(255, 0, 0)' },
            ilericimuhafazakar: { start: 'rgb(128, 0, 128)', end: 'rgb(0, 128, 0)' },
            kurmil: { start: 'rgb(255, 0, 0)', end: 'rgb(0, 0, 255)' },
            unifed: { start: 'rgb(0, 128, 0)', end: 'rgb(255, 255, 0)' }
        };

        function interpolateColor(color1, color2, factor) {
            const c1 = color1.match(/\d+/g).map(Number);
            const c2 = color2.match(/\d+/g).map(Number);
            const result = c1.map((c, i) => Math.round(c + (c2[i] - c) * factor));
            return `rgb(${result[0]}, ${result[1]}, ${result[2]})`;
        }

        axes.forEach(axis => {
            const score = scores[axis];
            if (score === null || isNaN(score)) return;

            const scoreLine = document.getElementById(`${axis}-score-line`);
            const scoreFactor = (score + maxScore) / (2 * maxScore);
            const startColor = colorSchemes[axis].start;
            const endColor = colorSchemes[axis].end;
            const interpolatedColor = interpolateColor(startColor, endColor, scoreFactor);

            scoreLine.style.width = `${scoreFactor * 100}%`;
            scoreLine.style.backgroundColor = interpolatedColor;
        });
    }

    function drawPoliticalCompass(scores) {
        const userDot = document.getElementById('user-position-dot');
        const totalSize = 300;

        if (scores.solsag === null || isNaN(scores.solsag) || scores.ilericimuhafazakar === null || isNaN(scores.ilericimuhafazakar)) {
            userDot.style.display = 'none';
            return;
        }

        userDot.style.display = 'block';

        const xPos = (scores.solsag + maxScore) / (2 * maxScore) * totalSize;
        const yPos = (scores.ilericimuhafazakar - maxScore) / (-2 * maxScore) * totalSize;

        userDot.style.left = `${xPos}px`;
        userDot.style.top = `${yPos}px`;
    }

    const partyScores = [
        { name: 'Adalet ve Kalkınma Partisi', solsag: 5, libotok: -15, ilericimuhafazakar: 15, kurmil: -15, unifed: 5, color: '#f8991d' },
        { name: 'Milliyetçi Hareket Partisi', solsag: 0, libotok: -15, ilericimuhafazakar: 15, kurmil: -20, unifed: 5, color: '#8e1c4b' },
        { name: 'Büyük Birlik Partisi', solsag: 0, libotok: -15, ilericimuhafazakar: 20, kurmil: -20, unifed: -5, color: '#ea2228' },
        { name: 'Hür Dava Partisi', solsag: 10, libotok: -15, ilericimuhafazakar: 20, kurmil: -10, unifed: 20, color: '#00953b' },
        { name: 'Cumhuriyet Halk Partisi', solsag: -5, libotok: 15, ilericimuhafazakar: -15, kurmil: 5, unifed: -15, color: '#e30613' },
        { name: 'İYİ Parti', solsag: 10, libotok: 10, ilericimuhafazakar: -10, kurmil: 0, unifed: -15, color: '#3cb4e5' },
        { name: 'Zafer Partisi', solsag: 0, libotok: 5, ilericimuhafazakar: -5, kurmil: -10, unifed: -20, color: '#414042' },
        { name: 'Halkların Eşitlik ve Demokrasi Partisi', solsag: -15, libotok: 15, ilericimuhafazakar: -15, kurmil: 20, unifed: 20, color: '#773e90' },
        { name: 'Türkiye İşçi Partisi', solsag: -20, libotok: 15, ilericimuhafazakar: -20, kurmil: 20, unifed: 15, color: '#ad1766' },
        { name: 'Yeniden Refah Partisi', solsag: 0, libotok: -10, ilericimuhafazakar: 20, kurmil: -20, unifed: -10, color: '#467d18' },
        { name: 'Anahtar Parti', solsag: 10, libotok: -5, ilericimuhafazakar: 15, kurmil: -10, unifed: -15, color: '#002157' },
        { name: 'Demokrasi ve Atılım Partisi', solsag: 15, libotok: 15, ilericimuhafazakar: 0, kurmil: 15, unifed: -5, color: '#0069a7' },
        { name: 'Gelecek Partisi', solsag: 15, libotok: 10, ilericimuhafazakar: 10, kurmil: 10, unifed: -10, color: '#0d6e4a' },
        { name: 'Saadet Partisi', solsag: 0, libotok: -5, ilericimuhafazakar: 15, kurmil: -20, unifed: -10, color: '#c16d4f' },
        { name: 'Bağımsız Türkiye Partisi', solsag: 0, libotok: 0, ilericimuhafazakar: 10, kurmil: -15, unifed: -20, color: '#c80008' }
    ];

    function calculatePartyDistances(userScores) {
        const distances = partyScores.map(party => {
            const distance = Math.sqrt(
                Math.pow(userScores.solsag - party.solsag, 2) +
                Math.pow(userScores.libotok - party.libotok, 2) +
                Math.pow(userScores.ilericimuhafazakar - party.ilericimuhafazakar, 2) +
                Math.pow(userScores.kurmil - party.kurmil, 2) +
                Math.pow(userScores.unifed - party.unifed, 2)
            );
            return { name: party.name, distance: distance, color: party.color };
        });

        const maxDistance = Math.max(...distances.map(d => d.distance));

        const scoresWithPercentage = distances.map(d => {
            const percentage = (1 - (d.distance / maxDistance)) * 100;
            return {
                name: d.name,
                percentage: percentage.toFixed(1),
                color: d.color
            };
        });

        scoresWithPercentage.sort((a, b) => b.percentage - a.percentage);
        return scoresWithPercentage.slice(0, 3);
    }

    function displayPartyResults(topParties) {
        const partyList = document.getElementById('party-list');
        partyList.innerHTML = '';
        topParties.forEach(party => {
            const listItem = document.createElement('li');
            listItem.innerHTML = `<span class="party-result-label" style="color: ${party.color};">${party.name}</span> <span class="distance-label">Yakınlık Skoru: %${party.percentage}</span>`;
            partyList.appendChild(listItem);
        });
    }

    function downloadResultsAsPng() {
        const elementToCapture = document.getElementById('results-card');

        html2canvas(elementToCapture, {
            scale: 2,
            backgroundColor: null,
            allowTaint: true,
            useCORS: true
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'siyasi-pusula-sonuc.png';
            link.href = canvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    }

    function initializeResultsPage() {
        const scores = getUrlParams();
        document.getElementById('solsag-result').innerText = getLabel(scores.solsag, 'solsag');
        document.getElementById('libotok-result').innerText = getLabel(scores.libotok, 'libotok');
        document.getElementById('ilericimuhafazakar-result').innerText = getLabel(scores.ilericimuhafazakar, 'ilericimuhafazakar');
        document.getElementById('kurmil-result').innerText = getLabel(scores.kurmil, 'kurmil');
        document.getElementById('unifed-result').innerText = getLabel(scores.unifed, 'unifed');

        updateScoreBars(scores);
        drawPoliticalCompass(scores);

        const topParties = calculatePartyDistances(scores);
        displayPartyResults(topParties);

        document.getElementById('download-btn').addEventListener('click', downloadResultsAsPng);
    }

    document.addEventListener('DOMContentLoaded', initializeResultsPage);
</script>
</body>
</html>